<template>
    <!-- Section 1: Evaluation Details -->
    <lightning-card title="Evaluation Details" icon-name="standard:contract" class="slds-m-bottom_medium">
        <div slot="actions">
            <lightning-button
                label="Reload"
                icon-name="utility:refresh"
                onclick={handleReload}
                disabled={isLoadingDetails}>
            </lightning-button>
        </div>
        <div class="slds-m-around_medium">
            <template if:true={isLoadingDetails}>
                <lightning-spinner alternative-text="Loading details..." size="small"></lightning-spinner>
                <p class="slds-text-align_center slds-m-top_small">Loading evaluation details...</p>
            </template>

            <template if:true={evalDetails}>
                <!-- Candidate Information -->
                <template if:true={candidateDoc}>
                    <div class="slds-box slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">Candidate Information</h3>
                        <dl class="slds-dl_horizontal">
                            <dt class="slds-dl_horizontal__label">Case ID:</dt>
                            <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">
                                <a href={candidateEvalUrl} target="_blank" rel="noopener noreferrer">{candidateDoc.caseId}</a>
                            </dd>

                            <dt class="slds-dl_horizontal__label">Name:</dt>
                            <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{candidateName}</dd>

                            <dt class="slds-dl_horizontal__label">Date of Birth:</dt>
                            <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{candidateDOB}</dd>

                            <dt class="slds-dl_horizontal__label">Document ID:</dt>
                            <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{candidateDoc.id}</dd>
                        </dl>
                    </div>
                </template>

                <!-- Document List -->
                <template if:true={hasDocuments}>
                    <h3 class="slds-text-heading_small slds-m-bottom_small">Documents ({documentCount})</h3>
                    <template for:each={documentList} for:item="doc">
                        <div key={doc._id} class="slds-box slds-m-bottom_small">
                            <div class="slds-grid slds-gutters">
                                <!-- Candidate Information -->
                                <div class="slds-col slds-size_1-of-2">
                                    <h4 class="slds-text-heading_small slds-m-bottom_x-small">Candidate Information</h4>
                                    <dl class="slds-dl_horizontal">
                                        <dt class="slds-dl_horizontal__label">Name:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.candidateDetails.fullName.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Date of Birth:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.candidateDetails.dateOfBirth.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Location:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.state.text}, {doc.country.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Translation:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.translation.from} â†’ {doc.translation.to}</dd>
                                    </dl>
                                </div>

                                <!-- Educational Details -->
                                <div class="slds-col slds-size_1-of-2">
                                    <h4 class="slds-text-heading_small slds-m-bottom_x-small">Educational Details</h4>
                                    <dl class="slds-dl_horizontal">
                                        <dt class="slds-dl_horizontal__label">University:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.universityName.text}</dd>

                                        <dt class="slds-dl_horizontal__label">College:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.collegeName.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Degree:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.degreeName.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Level:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.degreeLevel.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Program:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.program.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Major:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.major.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Year of Completion:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.yearOfCompletion.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Date of Issue:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.dateOfIssue.text}</dd>

                                        <dt class="slds-dl_horizontal__label">CGPA:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.cgpa.text}</dd>

                                        <dt class="slds-dl_horizontal__label">Total Credits:</dt>
                                        <dd class="slds-dl_horizontal__detail slds-m-bottom_x-small">{doc.educationalDetails.totalCredits.text}</dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- Course Grades -->
                            <template if:true={doc.courseGrades}>
                                <div class="slds-m-top_medium">
                                    <h5 class="slds-text-heading_small slds-m-bottom_x-small">Course Grades</h5>
                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                                        <thead>
                                            <tr class="slds-line-height_reset">
                                                <th scope="col"><div class="slds-truncate">Course Code</div></th>
                                                <th scope="col"><div class="slds-truncate">Course Name</div></th>
                                                <th scope="col"><div class="slds-truncate">Credits</div></th>
                                                <th scope="col"><div class="slds-truncate">Grade</div></th>
                                                <th scope="col"><div class="slds-truncate">Marks Scored</div></th>
                                                <th scope="col"><div class="slds-truncate">Max. Marks</div></th>
                                                <th scope="col"><div class="slds-truncate">Term</div></th>
                                                <th scope="col"><div class="slds-truncate">Year</div></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template for:each={doc.courseGrades} for:item="course">
                                                <tr key={course.id} class="slds-hint-parent">
                                                    <td><div class="slds-truncate">{course.courseCode.text}</div></td>
                                                    <td><div class="slds-truncate">{course.courseName.text}</div></td>
                                                    <td><div class="slds-truncate">{course.credit.text}</div></td>
                                                    <td><div class="slds-truncate">{course.grade.text}</div></td>
                                                    <td><div class="slds-truncate">{course.marksScored.text}</div></td>
                                                    <td><div class="slds-truncate">{course.maximumMarks.text}</div></td>
                                                    <td><div class="slds-truncate">{course.term.text}</div></td>
                                                    <td><div class="slds-truncate">{course.year.text}</div></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </template>

                            <!-- Files -->
                            <template if:true={doc.files}>
                                <div class="slds-m-top_small">
                                    <h5 class="slds-text-heading_small slds-m-bottom_x-small">Attached Files</h5>
                                    <template for:each={doc.files} for:item="file">
                                        <div key={file.url} class="slds-m-bottom_x-small">
                                            <lightning-button
                                                label="View Document"
                                                variant="base"
                                                icon-name="utility:file"
                                                onclick={handleViewFile}
                                                data-url={file.url}>
                                            </lightning-button>
                                            <template if:true={file.tags}>
                                                <lightning-badge label={file.tags} class="slds-m-left_x-small"></lightning-badge>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </template>
            </template>

            <template if:true={detailsError}>
                <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
                    <span class="slds-assistive-text">Error</span>
                    <lightning-icon icon-name="utility:error"
                                  alternative-text="Error"
                                  size="x-small"
                                  variant="inverse"
                                  class="slds-m-right_x-small">
                    </lightning-icon>
                    {detailsError}
                </div>
            </template>
        </div>
    </lightning-card>

    <!-- Section 2: File Upload -->
    <lightning-card title="File Upload" icon-name="doctype:attachment">
        <div class="slds-m-around_medium">
            <template if:false={isUploading}>
                <lightning-input
                    type="file"
                    label="Select File"
                    accept=".pdf,.doc,.docx,.txt,.jpg,.png"
                    onchange={handleFileChange}
                    disabled={isUploading}>
                </lightning-input>

                <template if:true={fileName}>
                    <div class="slds-m-top_small">
                        <p><strong>Selected File:</strong> {fileName}</p>
                        <p><strong>Size:</strong> {fileSize}</p>
                    </div>
                </template>

                <lightning-button
                    label="Upload & Send to API"
                    variant="brand"
                    onclick={handleUpload}
                    disabled={disableUpload}
                    class="slds-m-top_medium">
                </lightning-button>
            </template>

            <template if:true={isUploading}>
                <lightning-spinner alternative-text="Uploading..." size="medium"></lightning-spinner>
                <p class="slds-text-align_center slds-m-top_small">Processing file...</p>
            </template>

            <template if:true={successMessage}>
                <div class="slds-m-top_medium">
                    <div class="slds-notify slds-notify_alert slds-alert_success" role="alert">
                        <span class="slds-assistive-text">Success</span>
                        <lightning-icon icon-name="utility:success"
                                      alternative-text="Success"
                                      size="x-small"
                                      variant="inverse"
                                      class="slds-m-right_x-small">
                        </lightning-icon>
                        {successMessage}
                    </div>
                </div>
            </template>

            <template if:true={errorMessage}>
                <div class="slds-m-top_medium">
                    <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
                        <span class="slds-assistive-text">Error</span>
                        <lightning-icon icon-name="utility:error"
                                      alternative-text="Error"
                                      size="x-small"
                                      variant="inverse"
                                      class="slds-m-right_x-small">
                        </lightning-icon>
                        {errorMessage}
                    </div>
                </div>
            </template>
        </div>
    </lightning-card>
</template>
